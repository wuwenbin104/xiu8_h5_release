let TIMSDK={tim:null,newMessage:null,loginStatus:!1,groupInfo:{groupID:-1,groupName:""},moduleName:"immodule",loginAndCreate:function(e,o,t){if(null==TIMSDK.tim){const o=TIM.create({SDKAppID:e});o.setLogLevel(4),TIMSDK.tim=o}TIMSDK.tim.on(TIM.EVENT.MESSAGE_RECEIVED,TIMSDK.onMessageReceived),TIMSDK.login(o,t,()=>{TIMSDK.createRoom(o)})},loginAndEnter:function(e,o,t,n,r){if(null==TIMSDK.tim){const o=TIM.create({SDKAppID:e});o.setLogLevel(4),TIMSDK.tim=o}TIMSDK.tim.on(TIM.EVENT.MESSAGE_RECEIVED,TIMSDK.onMessageReceived),TIMSDK.login(t,n,()=>{TIMSDK.enterRoom(o,r)})},login:function(e,o,t){TIMSDK.tim.login({userID:e,userSig:o}).then(()=>{TIMSDK.loginStatus=!0,cc.log("\u767b\u5f55\u6210\u529f!"),t&&t()}).catch(e=>{this.loginStatus=!1,cc.log("\u767b\u5f55\u5931\u8d25\uff1aerror=",e.message,",userSig=",o)})},logout:function(){TIMSDK.tim.logout().then(function(e){console.log("\u767b\u51fa\u6210\u529f",e.data),TIMSDK.loginStatus=!1}).catch(function(e){console.warn("\u767b\u51fa\u5931\u6557 error:",e)})},createRoom:function(e){let o={type:TIM.TYPES.GRP_AVCHATROOM,name:e,memberList:[{userID:e}]};TIMSDK.tim.createGroup(o).then(o=>{TIMSDK.groupInfo.groupID=e,TIMSDK.groupInfo.groupName=o.data.group.name,cc.log(`\u7fa4\u7ec4\uff1a\u3010${o.data.group.name}\u3011\u521b\u5efa\u6210\u529f`)}).catch(e=>{cc.log("\u7fa4\u7ec4\u521b\u5efa\u5931\u6557 error=",e.message)})},enterRoom:function(e,o){null!=TIMSDK.tim&&(cc.log("enterRoom\uff1a",e),TIMSDK.tim.joinGroup({groupID:e}).then(async t=>{switch(cc.log("\u52a0\u5165\u623f\u9593\u8fd4\u56de\uff1a",t.data),TIMSDK.groupInfo.groupID=e,TIMSDK.groupInfo.groupName=e,t.data.status){case TIM.TYPES.JOIN_STATUS_WAIT_APPROVAL:cc.log("\u7533\u8bf7\u6210\u529f\uff0c\u7b49\u5f85\u7fa4\u7ba1\u7406\u5458\u786e\u8ba4\u3002");break;case TIM.TYPES.JOIN_STATUS_SUCCESS:cc.log("\u52a0\u7fa4\u6210\u529f!");break;case TIM.TYPES.JOIN_STATUS_ALREADY_IN_GROUP:cc.log("\u60a8\u5df2\u7ecf\u662f\u7fa4\u6210\u5458\u4e86\uff0c\u8bf7\u52ff\u91cd\u590d\u52a0\u7fa4\u54e6\uff01"),TIMSDK.quitGroup(e,()=>{TIMSDK.enterRoom(e,o)})}o&&o("ok")}).catch(e=>{cc.log("\u52a0\u5165\u7fa4\u7ec4\u5931\u6557 error=",e.message)}))},quitGroup:function(e,o){null!=TIMSDK.tim&&TIMSDK.tim.quitGroup(e).then(function(e){TIMSDK.groupInfo.groupID=-1,TIMSDK.groupInfo.groupName="",o&&o(),console.log("\u9000\u51fa\u7fa4\u6210\u529f id=",e.data.groupID)}).catch(function(e){console.warn("\u9000\u51fa\u7fa4\u7ec4\u5931\u8d25 error:",e)})},sendMessage:function(e){if(null==TIMSDK.tim)return;let o=TIMSDK.tim.createTextMessage({to:TIMSDK.groupInfo.groupID,conversationType:TIM.TYPES.CONV_GROUP,payload:{text:e}});TIMSDK.tim.sendMessage(o).then(function(e){console.log("\u53d1\u9001\u6210\u529f",e)}).catch(function(e){console.warn("\u53d1\u9001\u5931\u6557 error:",e)})},onMessageReceived:function(e){let o=e.data;TIMSDK.newMessage&&o.forEach(e=>{e.conversationType==TIM.TYPES.CONV_C2C||(e.conversationType==TIM.TYPES.CONV_GROUP?e.to==TIMSDK.groupInfo.groupID&&TIMSDK.onRecvGroupMsg(e):e.conversationType==TIM.TYPES.CONV_SYSTEM&&TIMSDK.onSystemMsg(e))})},onSystemMsg:function(e){e.elements.forEach(o=>{if(o.type==TIM.TYPES.MSG_GRP_SYS_NOTICE)if(5==o.operationType){cc.log("\u6709\u7fa4\u6210\u5458\u9000\u7fa4groupID:",e.to);let o={};o.module=TIMSDK.moduleName,o.event="onGroupDelete",o.param={groupID:e.to},TIMSDK.newMessage(JSON.stringify(o))}else 255==o.operationType&&cc.log("onSystemMsg-onMemberChange\uff01")})},onRecvGroupMsg:function(e){e.elements.forEach(o=>{if(o.type==TIM.TYPES.MSG_TEXT){cc.log("\u6587\u672c\u6d88\u606f:",o.content.text);let t={};t.module=TIMSDK.moduleName,t.event="onRecvGroupTextMsg",t.param={groupID:e.to,userID:o.operatorID,userName:e.nick,userAvatar:e.avatar,textMsg:o.content.text},TIMSDK.newMessage(JSON.stringify(t))}else if(o.type==TIM.TYPES.MSG_CUSTOM)cc.log("\u6709\u81ea\u5b9a\u4e49\u6d88\u606f:",o.content.data);else if(o.type==TIM.TYPES.MSG_GRP_TIP){if(o.content.operationType==TIM.TYPES.GRP_TIP_MBR_QUIT){cc.log("\u6709\u7fa4\u6210\u5458\u9000\u7fa4:",o.content.groupProfile);let t={};t.module=TIMSDK.moduleName,t.event="onGroupMemberLeave",t.param={group:e.to,userID:o.content.operatorID,userName:e.nick,userAvatar:e.avatar},TIMSDK.newMessage(JSON.stringify(t))}else if(o.content.operationType==TIM.TYPES.GRP_TIP_MBR_JOIN){cc.log("\u6709\u6210\u5458\u52a0\u7fa4:",o.content.groupProfile);let t={};t.module=TIMSDK.moduleName,t.event="onGroupMemberEnter",t.param={group:e.to,userID:o.content.operatorID,userName:e.nick,userAvatar:e.avatar},TIMSDK.newMessage(JSON.stringify(t))}}else if(o.type==TIM.TYPES.MSG_GRP_SYS_NOTICE){let o={};o.module=TIMSDK.moduleName,o.event="onGroupDelete",o.param={groupID:e.to},TIMSDK.newMessage(JSON.stringify(o))}})},getUserStatus:function(e){return TIMSDK.loginStatus}};